<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¹é«”ä¸­æ–‡ç­†é †ç·´ç¿’</title>
  <script src="hanzi-writer.min.js"></script>
  <link rel="preload" href="fonts/BpmfIansui-Regular.ttf" as="font" type="font/ttf" crossorigin>
  <style>
    .page-description {
    /* è®“æ–‡å­—ç½®ä¸­å°é½Š */
    text-align: center;
    
    /* è¨­å®šé©åˆæ·±è‰²èƒŒæ™¯çš„æ–‡å­—é¡è‰² */
    color: #ECEFF1;

    /* è¨­å®šèˆ‡ä¸‹æ–¹æŒ‰éˆ•çš„é–“è· */
    margin-bottom: 25px;

    /* å…¶ä»–å¯é¸æ¨£å¼ */
    font-size: 1em;
    font-weight: normal;
    max-width: 500px; /* é¿å…åœ¨å¯¬è¢å¹•ä¸Šæ–‡å­—è¡Œéé•· */
    margin-left: auto;   /* æ­é… max-width å¯¦ç¾ç½®ä¸­ */
    margin-right: auto;  /* æ­é… max-width å¯¦ç¾ç½®ä¸­ */
    line-height: 1;    /* å¢åŠ è¡Œé«˜ï¼Œè®“æ–‡å­—æ›´å¥½é–±è®€ */
    }

    /* --- å…¨åŸŸè¨­å®š --- */
    html {
      scroll-behavior: smooth;
    }
    
/* âœ¨ æ–°å¢ï¼šå¼·åˆ¶æ‰€æœ‰æŒ‰éˆ•å’Œè¼¸å…¥æ¡†ç¹¼æ‰¿å­—é«” */
    button,
    input,
    select,
    textarea {
      font-family: inherit; /* é—œéµï¼è®“é€™äº›å…ƒç´ ç¹¼æ‰¿çˆ¶å±¤çš„å­—é«”è¨­å®š */
    }

    body {
      font-family: 'MyGlobalFont', "PingFang TC", "Microsoft JhengHei", sans-serif;
      /* ... æ‚¨å…¶ä»–çš„ body æ¨£å¼ ... */
    }
    body{
      font-family:'FangYun','Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      margin:0;
      color:#333;
      font-weight:600;
      background-color: #f4f4f4; /* ç‚ºé é¢ä¹‹é–“è¨­å®šä¸€å€‹çµ±ä¸€çš„åº•è‰² */
    }
    
    /* --- é¦–é å€å¡Šæ¨£å¼ --- */
    #home-page {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      height: 100vh;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
      background-image: url('images/homepage.webp'); 
      background-size: cover; 
      background-position: center; 
      background-repeat: no-repeat; 
    }

    #home-page h1 {
      font-size: 3em;
      color: #5D4037;
      text-shadow: 0px 2px 4px rgba(255, 255, 255, 0.5);
      margin: 10px 0;
      font-weight: 700;
    }

    #home-page .start-button {
      display: inline-block;
      margin-top: 30px;
      padding: 15px 40px;
      font-size: 1.2em;
      font-weight: 600;
      color: white;
      background-color: #A1887F;
      border-radius: 50px;
      text-decoration: none;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    #home-page .start-button:hover {
      background-color: #8D6E63;
      transform: translateY(-2px);
    }

    /* --- ç­†é †ç·´ç¿’å€å¡Šæ¨£å¼ --- */
    #practice-page {
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      padding:10px 80px 40px 10px; /* å¢åŠ åº•éƒ¨ padding */
      box-sizing: border-box;
      min-height: 100vh;
      position: relative;
      background-color: #fff8eb; /* ä½¿ç”¨ç´”ç™½èƒŒæ™¯ */
    }

    /* --- æ–°å¢ï¼šå­¸ç¿’é€²åº¦é é¢æ¨£å¼ --- */
    /* --- å­¸ç¿’é€²åº¦é é¢æ¨£å¼ --- */
    #progress-page {
        display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 40px 20px; box-sizing: border-box; background: linear-gradient(135deg, #fff8eb 0%, #fef9ed 100%);
    }
    /* âœ¨ ä»¥ä¸‹æ˜¯å¯¦ç¾å·¦å³ä½ˆå±€çš„é—œéµ CSS âœ¨ */
    .progress-main-layout {
        display: flex; flex-direction: row; align-items: flex-start; gap: 30px; width: 100%; max-width: 900px; margin-bottom: 30px;
    }
    .progress-left-column {
        flex: 1; display: flex; flex-direction: column; gap: 0px;
    }
    .progress-right-column {
        flex: 1; display: flex; align-items: flex-start;
    }
    /* åœ¨å°è¢å¹•ä¸Šè®Šå›å‚ç›´æ’åˆ— */
    @media (max-width: 768px) {
      .progress-main-layout {
        flex-direction: column;
      }
    }

    .progress-container {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        width: 90%;
        max-width: 600px;
        margin-bottom: 10px;
    }

    .progress-container h2 {
        font-size: 1.8em;
        color: #00695c;
        margin-top: 0;
        margin-bottom: 20px;
    }

    #progress-char-count-display {
        font-size: 4em;
        font-weight: 700;
        color: #FFD700; /* é‡‘è‰² */
        line-height: 1;
    }
    
    #progress-char-count-display .star-icon {
        font-size: 0.8em; /* æ˜Ÿæ˜Ÿæ¯”æ•¸å­—å°ä¸€é» */
        vertical-align: super;
        margin-right: 5px;
    }

    #progress-levels-list {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 12px;
        margin-top: 20px;
    }

    .progress-level-item {
        background-color: #28a745;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 1.1em;
        font-weight: 600;
    }
    
    .progress-level-placeholder {
        color: #888;
        font-style: italic;
    }
    /* æ–°å¢ï¼šå³å´çå‹µåœ–ç‰‡å®¹å™¨æ¨£å¼ */
    #progress-reward-image-container {
        background-color: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        text-align: center;
        width: 100%;
        aspect-ratio: 1 / 1
    }

/* âœ¨ æ–°å¢ï¼šæ§åˆ¶æˆå°±åœ–ç‰‡çš„å¤§å°å’Œæ¨£å¼ */
    #progress-reward-image-container img {
        width: 100%; /* å¯¬åº¦å¡«æ»¿å…¶ç™½è‰²å®¹å™¨ */
        max-width: 100%;
        max-height: 250px; /* è¨­å®šä¸€å€‹æœ€å¤§é«˜åº¦ï¼Œæ‚¨å¯ä»¥è‡ªè¡Œèª¿æ•´é€™å€‹æ•¸å­— */
        object-fit: cover; /* ç¢ºä¿åœ–ç‰‡åœ¨é™åˆ¶å°ºå¯¸å…§èƒ½å®Œæ•´é¡¯ç¤ºï¼Œä¸è®Šå½¢ */
        border-radius: 8px;
        margin-bottom: 15px;
    }

    #progress-reward-image-container h3 {
        font-size: 1.4em;
        color: #BF360C;
        margin: 0 0 5px 0;
    }

    #progress-reward-image-container p {
        color: #555;
        margin: 0;
    }
    .back-button {
      display: inline-block;
      margin-top: 30px;
      padding: 12px 25px;
      font-size: 1em;
      font-weight: 600;
      color: #333;
      background-color: #e0e0e0;
      border-radius: 50px;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }
    .back-button:hover {
      background-color: #bdbdbd;
    }


    /* æ–°å¢ï¼šå‰å¾€é€²åº¦é é¢çš„æŒ‰éˆ•æ¨£å¼ */
    .progress-link-button {
        display: inline-block;
        margin-top: 20px;
        background-color: #f9a898;
        color: white;
        padding: 10px 20px;
        border-radius: 50px;
        text-decoration: none;
        font-weight: 600;
        transition: background-color 0.3s ease;
    }
    .progress-link-button:hover {
        background-color: #f9a898;
    }

/* âœ¨ 1. æ–°å¢ï¼šå®šç¾©æ‚¨çš„ã€Œå…¨åŸŸå­—é«”ã€ */
    @font-face {
      font-family: 'FangYun'; /* ç‚ºæ‚¨çš„å…¨åŸŸå­—é«”å–ä¸€å€‹ç¨ç‰¹çš„åå­— */
      src: url('fonts/jf-openhuninn-2.1.ttf') format('truetype'); /* æŒ‡å‘æ‚¨çš„å­—é«”æª”æ¡ˆ */
      font-weight: normal;
      font-style: normal;
    }

    /* --- ä»¥ä¸‹ç‚ºåŸæœ‰çš„å…¶ä»– CSS (å·²æ•´åˆ) --- */
    @font-face {
      font-family: 'CoriandrumCustom';
      src: url('fonts/BpmfIansui-Regular.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    #practice-page h1{
      color:#Fa9782;
      margin-bottom:15px;
      font-weight:700;
      font-size: 1.8em;
    }
    .subtitle{
      font-size:1em;
      color:#555;
      margin-bottom:10px;
      font-weight:normal
    }
    #input-mode-selector{
      margin-bottom:15px;
      display:flex;
      flex-wrap: wrap;
      justify-content: center;
      gap:10px
    }
    .mode-button {
      font-size:15px;
      padding:8px 15px;
      border:1px solid #76d7c4;
      background-color:#fff;
      color:#76d7c4;
      border-radius:6px;
      cursor:pointer;
      transition:background-color .3s ease,color .3s ease;
      font-weight:600
    }
    .mode-button.active, .mode-button:hover {
      background-color:#76d7c4;
      color:#fff
    }
    #input-container {
      display:flex;
      flex-direction:column;
      align-items:center;
      margin-bottom:15px;
      gap:10px;
      width:95%;
      max-width:400px;
    }
    #level-selection-container {
      display:flex;
      flex-direction:column;
      align-items:center;
      margin-bottom:15px;
      gap:10px;
      width:80%;
      max-width: 500px;
    }

    #level-buttons-area {
        margin-top: 10px;
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        gap: 4px;
        justify-content: space-evenly;
        align-items: center;
        width: 80%;
        padding: 0px;
        box-sizing: border-box;
    }

    .level-select-btn {
        padding: 4px 5px;
        background-color: #82E0AA;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        width: auto;
        min-width: 10px;
        flex-shrink: 1;
        flex-grow: 1;
        white-space: nowrap;
        transition: background-color .3s ease;
    }

    #text-input-area,
    #file-input-area{
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px
    }
    #text-input{
      font-size:16px;
      padding:10px;
      width:100%;
      box-sizing: border-box;
      text-align:center;
      border:1px solid #ddd;
      border-radius:6px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease; /* è®“é»é¸æ™‚çš„è®ŠåŒ–æ›´å¹³é † */

      /* --- âœ¨ é¡è‰²ä¿®æ”¹å€ --- */
      background-color: #FAF8F5;   /* 1. ä¿®æ”¹ï¼šè¼¸å…¥æ¡†çš„èƒŒæ™¯è‰² (ç±³ç™½è‰²) */
      color: #5D4037;              /* 2. ä¿®æ”¹ï¼šä½¿ç”¨è€…è¼¸å…¥çš„æ–‡å­—é¡è‰² (æ·±æ£•è‰²) */
      border: 1px solid #D7CCC8;   /* 3. ä¿®æ”¹ï¼šè¼¸å…¥æ¡†çš„é‚Šæ¡†é¡è‰² (æ·ºæ£•è‰²) */
      box-shadow: inset 0 1px 3px rgba(0,0,0,.05);
    }

    /* âœ¨ 4. æ–°å¢ï¼šä¿®æ”¹æç¤ºæ–‡å­—çš„é¡è‰² */
    #text-input::placeholder {
      color: #A1887F; /* æç¤ºæ–‡å­—ä½¿ç”¨ä¸­ç­‰æ£•è‰² */
    }

    /* âœ¨ 5. æ–°å¢ï¼šä¿®æ”¹é»é¸è¼¸å…¥æ¡†æ™‚çš„å¤–è§€ */
    #text-input:focus {
      outline: none; /* ç§»é™¤ç€è¦½å™¨é è¨­çš„è—è‰²å¤–æ¡† */
      border-color: #A1887F; /* é‚Šæ¡†è®Šç‚ºè¼ƒæ·±çš„é¡è‰² */
      box-shadow: 0 0 0 3px rgba(161, 136, 127, 0.2); /* åŠ ä¸ŠæŸ”å’Œçš„ç™¼å…‰æ•ˆæœ */
    }
    
    #file-input{display:none}
    .file-input-label{
      font-size:16px;
      padding:10px 15px;
      background-color:#fff;
      color:#76d7c4;
      border:1px dashed #76d7c4;
      border-radius:6px;
      cursor:pointer;
      transition:background-color .3s ease,color .3s ease;
      width:100%;
      box-sizing:border-box;
      font-weight:600
    }
    .file-input-label:hover{background-color:#e0f7fa}
    #selected-file-name{
      font-size:.9em;
      color:#555;
      margin-top:5px;
      word-break:break-all;
      font-weight:normal
    }
    #process-data-button{
      font-size:17px;
      padding:10px 20px;
      background-color:#76d7c4;
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
      transition:background-color .3s ease;
      width:100%;
      box-sizing:border-box;
      font-weight:600
    }
    #process-data-button:hover{background-color:#65bcaa}
    #character-selection-buttons-container{
      width:95%;
      max-width:600px;
      margin-bottom:15px
    }
    #character-selection-buttons{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:8px
    }
    .char-select-button{
      padding:8px 12px;
      background-color:#ffdab9;
      color:#333;
      border:1px solid #ffcfaa;
      border-radius:6px;
      cursor:pointer;
      transition:background-color .2s ease,color .2s ease,border-color .2s ease;
      font-family:'CoriandrumCustom','èŠ«è½é«”',sans-serif;
      font-size:1.5em;
      font-weight:normal;
      line-height:1.3;
      min-width:50px
    }
    .char-select-button:hover{background-color:#ffc8a2;border-color:#ffb77e}
    .char-select-button.active{
      background-color:#ffc8a2;
      color:#333;
      border-color:#ffb77e;
      box-shadow:0 0 0 2px #ffb77e inset
    }

    #practice-mode-selector {
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      width: 95%;
      max-width: 400px;
    }
    .practice-mode-button {
      font-size: 15px;padding: 8px 15px;border: 1px solid #C78482;background-color: #fff;color: #Fa9782;border-radius: 6px;cursor: pointer;transition: background-color 0.3s ease, color 0.3s ease;font-weight: 600;
    }
    .practice-mode-button.active,
    .practice-mode-button:hover {
      background-color: #Fa9782;color: white;
    }

    .display-area-container{
      display:flex;
      flex-direction: column;
      align-items: center;
      gap:10px;
      width:95%;
      max-width: 580px;
      margin-bottom:0px;
    }
    #animation-wrapper{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      width:100%;
      max-width: 200px;
    }
    #quiz-area-wrapper{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      width:100%;
      max-width: 350px;
    }

    .hanzi-box{
      background-color:#fff;
      border:1px solid #ddd;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,.08);
      display:flex;
      justify-content:center;
      align-items:center;
      position:relative;
      box-sizing: border-box;
    }
    #animation-display.hanzi-box{
      width: 150px;
      height: 150px;
    }
    #quiz-display.hanzi-box{
      width: 280px;
      height: 280px;
      touch-action:none;
      position: relative;
      margin: 0 auto;
    }

    #replay-animation-button,
    #hint-next-stroke-button {
      padding: 6px 10px;
      font-size: 0.9em;
      font-size:14px;background-color:#76d7c4;color:#fff;border:none;border-radius:4px;cursor:pointer;transition:background-color .3s ease;font-weight:600
    }
    #replay-animation-button:hover{background-color:#65bcaa}
    #replay-animation-button:disabled{background-color:#b0bec5;color:#78909c;cursor:not-allowed}

    #quiz-controls {
      margin-top: 0px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #hint-next-stroke-button {
      background-color: #ffdab9;color: #333;display: none;
    }
    #hint-next-stroke-button:hover {background-color: #ffdab9;}
    #hint-next-stroke-button:disabled { background-color: #E0E0E0; color: #A0A0A0; cursor: not-allowed; opacity: 0.7; }

    #practiced-characters-container{
      margin-top:5px;padding:15px;width:95%;max-width:600px;background-color:#fdfdfd;border:1px solid #eee;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.05)
    }
    #practiced-characters-container h2{
      color:#00695c;font-size:1.3em;margin-top:0;margin-bottom:10px;font-weight:700
    }
    #practiced-characters-list{
      display:flex;flex-wrap:wrap;gap:8px;justify-content:center;font-weight:normal;min-height:2em
    }
    .practiced-char-item{
      background-color:#e0f2f1;color:#00796b;padding:5px 10px;border-radius:4px;font-size:1.1em
    }
    
    #congrats-overlay{
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      display: none;
      z-index: 1000;
      pointer-events: auto;
      background-color: rgba(255, 255, 255, 0.9);
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    #congrats-overlay .congrats-image {
      max-width: 80%;
      max-height: 60vh;
      width: 300px;
      margin-top: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }
    #congrats-overlay h2 {
      color:#C78B8D;
      font-size: 2.2em;
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
      margin: 0;
      padding: 0 20px;
    }

    #music-controls {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    #play-pause-music-button {
        font-size: 14px;
        padding: 8px 15px;
        background-color: #76D7C4;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s ease, opacity 0.3s ease;
        font-weight: 600;
        min-width: 120px;
    }
    #play-pause-music-button:hover {
        background-color: #65BCAA;
    }
    #play-pause-music-button:disabled {
      background-color: #B0BEC5;
      color: #78909C;
      cursor: not-allowed;
      opacity: 0.7;
    }

    #reward-display-container {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 100px;
      z-index: 20;
      transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
      pointer-events: auto;
      display: none;
    }
    #reward-display-container img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    #star-count-display {
      display: none;
    }

    #auth-ui {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 5px;
        padding: 5px;
        border-radius: 8px;
        max-width: 45%; 
        box-sizing: border-box;
    }

    #auth-ui button {
        font-size: 13px;
        padding: 6px 10px;
        margin: 0;
        width: fit-content;
        white-space: nowrap;
        text-align: center;
    }

    #user-status {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.9em;
        color: #444;
        margin: 0;
        white-space: nowrap;
        font-weight: bold;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }

    #user-status img {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        vertical-align: middle;
        margin-right: 3px;
        flex-shrink: 0;
    }

    @media (min-width: 601px) {
      .display-area-container {
        flex-direction: row;
        align-items: flex-start;
        max-width: 580px;
      }
      #animation-wrapper, #quiz-area-wrapper { width: auto; max-width: none; }
      #animation-display.hanzi-box { width: 180px; height: 180px; }
      #quiz-display.hanzi-box { width: 350px; height: 350px; }
      #reward-display-container { width: 120px; }
    }

    @media (max-width: 600px) {
        #practice-page {
            padding: 50px 5px 10px 5px; 
        }
        #auth-ui {
            top: 5px;
            right: 5px;
            max-width: auto;
            width: fit-content;
            align-items: flex-end;
        }

        #auth-ui button {
            font-size: 12px;
            padding: 5px 8px;
        }

        #user-status {
            font-size: 0.8em;
        }

        #practice-page h1 {
            margin-top: 0px;
            padding-top: 10px;
        }
/* --- âœ¨ æ–°å¢ï¼šå·¦å³å…©æ¬„ä½ˆå±€çš„æ¨£å¼ --- */
        .progress-main-layout {
            display: flex; /* å•Ÿç”¨ Flexbox ä½ˆå±€ */
            flex-direction: row; /* è¨­å®šä¸»è»¸æ–¹å‘ç‚ºæ°´å¹³ï¼ˆå·¦å³ä¸¦æ’ï¼‰ */
            align-items: flex-start; /* è®“å·¦å³æ¬„é ‚éƒ¨å°é½Š */
            gap: 30px; /* å·¦å³æ¬„ä¹‹é–“çš„é–“è· */
            width: 100%;
            max-width: 900px; /* è¨­å®šæ•´å€‹ä½ˆå±€çš„æœ€å¤§å¯¬åº¦ */
            margin-bottom: 30px;
        }

        .progress-left-column {
            flex: 1; /* è®“å·¦æ¬„è‡ªå‹•åˆ†é…å¯ç”¨ç©ºé–“ */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .progress-right-column {
            flex: 1; /* è®“å³æ¬„è‡ªå‹•åˆ†é…å¯ç”¨ç©ºé–“ */
            display: flex;
            align-items: flex-start; /* è®“å…§å®¹å¾é ‚éƒ¨é–‹å§‹ */
        }

        /* é‡å°æ‰‹æ©Ÿç­‰å°è¢å¹•çš„å„ªåŒ– */
        @media (max-width: 768px) {
          .progress-main-layout {
            flex-direction: column; /* åœ¨å°è¢å¹•ä¸Šï¼Œæ”¹å›å‚ç›´å †ç–Šï¼Œé¿å…æ“ å£“ */
          }
        }    
    }
        /* --- æ–°å¢ï¼šä¸‰å±¤é—œå¡é¸æ“‡ä»‹é¢æ¨£å¼ --- */
        .level-tier-container {
            display: flex;
            flex-direction: row;
            gap: 15px;
            justify-content: center;
            width: 100%;
        }

        .level-selection-column {
            flex: 1;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            min-width: 150px;
        }

        .level-selection-title {
            margin: 0 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #76d7c4;
            color: #00695c;
            font-size: 1.1em;
        }

        .level-buttons-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tier-button {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            font-weight: 600;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: #fff;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        .tier-button:hover {
            background-color: #e0e0e0;
        }

        .tier-button.active {
            background-color: #76d7c4;
            color: white;
            border-color: #76d7c4;
        }

        #reset-level-selection-button {
            font-size: 14px;
            padding: 8px 15px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        /* å°è¢å¹•ä¸Šæ”¹ç‚ºå‚ç›´æ’åˆ— */
        @media (max-width: 600px) {
          .level-tier-container {
            flex-direction: column;
          }
        }    
        /* --- âœ¨ 2. æ–°å¢ï¼šå¤–éƒ¨é€£çµé é¢æ¨£å¼ --- */
        #links-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 80vh; /* ä¸éœ€è¦ä½”æ»¿å…¨è¢å¹•ï¼Œæ„Ÿè¦ºæ›´åƒé å°¾ */
            padding: 60px 20px;
            box-sizing: border-box;
            background-color: #ab9187; 
            color: #CFD8DC;
        }

        #links-page h2 {
            font-size: 2em;
            color: white;
            margin-bottom: 5px;
        }

        .links-page-content {
            width: 100%;
            max-width: 900px;
            text-align: center;
            margin-bottom: 40px;
        }

        #links-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* éŸ¿æ‡‰å¼ç¶²æ ¼ä½ˆå±€ */
            gap: 20px; /* å¡ç‰‡é–“è· */
            margin-top: 30px;
            text-align: left;
        }

        .link-card {
            display: flex;
            align-items: center;
            gap: 15px;
            background-color: #89746c;
            padding: 20px;
            border-radius: 8px;
            color: #ECEFF1;
            text-decoration: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .link-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .link-card-icon {
            font-size: 2em;
            flex-shrink: 0;
        }

        .link-card-text h4 {
            margin: 0 0 5px 0;
            color: white;
            font-size: 1.1em;
        }

        .link-card-text p {
            margin: 0;
            font-size: 0.9em;
            font-weight: normal;
            opacity: 0.8;
        }
        /* --- âœ¨ 2. æ–°å¢ï¼šé å°¾ç¤¾ç¾¤é€£çµæ¨£å¼ --- */
        #social-links-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px; /* åœ–ç¤ºä¹‹é–“çš„é–“è· */
            margin-top: 30px; /* èˆ‡ä¸Šæ–¹æŒ‰éˆ•çš„é–“è· */
        }

        .social-link {
            display: inline-block;
            transition: transform 0.2s ease;
        }

        .social-link:hover {
            transform: scale(1.15); /* æ»‘é¼ ç§»ä¸Šå»æ™‚ç¨å¾®æ”¾å¤§ */
        }

        .social-link img {
            width: 40px; /* è¨­å®šåœ–ç¤ºçš„å¯¬åº¦ */
            height: 40px; /* è¨­å®šåœ–ç¤ºçš„é«˜åº¦ */
        }
        /* --- âœ¨ æ–°å¢ï¼šç”¨æ–¼å¼·åˆ¶æ›è¡Œçš„ç¶²æ ¼æ¨£å¼ --- */
        .grid-row-break {
            grid-column: 1 / -1; /* é—œéµï¼è®“é€™å€‹å…ƒç´ ä½”æ»¿ä¸€æ•´æ’çš„å¯¬åº¦ */
            height: 0; /* å®ƒæœ¬èº«ä¸éœ€è¦é«˜åº¦ */
            margin: 0;
            padding: 0;
        }
  </style>
</head>

<body>
  <div style="display: none;">
    <svg id="hanzi-grid-template" xmlns="http://www.w3.org/2000/svg">
        <line x1="0" y1="0" x2="100%" y2="100%" stroke="#DDD"></line>
        <line x1="100%" y1="0" x2="0" y2="100%" stroke="#DDD"></line>
        <line x1="50%" y1="0" x2="50%" y2="100%" stroke="#DDD"></line>
        <line x1="0" y1="50%" x2="100%" y2="50%" stroke="#DDD"></line>
    </svg>
  </div>
  <section id="home-page">
    <h1>ç¹é«”ä¸­æ–‡ç­†é †ç·´ç¿’</h1>
    <a href="#practice-page" class="start-button">é–‹å§‹ç·´ç¿’</a>
  </section>

  <main id="practice-page">

    <div id="auth-ui">
      <button id="google-login-button" class="mode-button" style="background-color: #fa9782; color: white;">
          ä½¿ç”¨ Google ç™»å…¥
      </button>
      <button id="logout-button" class="mode-button" style="background-color: #4285F4; color: white; display: none;">
          ç™»å‡º
      </button>
      <span id="user-status">è«‹ç™»å…¥ä»¥ä¿å­˜ä½ çš„é€²åº¦ã€‚</span>
    </div>

    <h1>ç¹é«”ä¸­æ–‡ç­†é †ç·´ç¿’</h1>

    <div id="music-controls">
      <audio id="background-audio"></audio>
      <button id="play-pause-music-button"></button>
    </div>

    <div id="input-mode-selector">
      <button id="direct-input-mode-btn" class="mode-button"></button>
      <button id="file-input-mode-btn" class="mode-button"></button>
      <button id="level-select-mode-btn" class="mode-button"></button>
    </div>

    <div id="input-container" style="position:relative;">
      <div id="text-input-area">
        <input type="text" id="text-input" placeholder="è¼¸å…¥æˆ–è²¼ä¸Šç·´ç¿’æ–‡å­—">
      </div>
      <div id="file-input-area" style="display:none;">
        <label for="file-input" class="file-input-label">é»æ­¤é¸æ“‡ .txt æª”æ¡ˆ</label>
        <input type="file" id="file-input" accept=".txt">
        <span id="selected-file-name"></span>
      </div>
      <button id="process-data-button"></button>
    </div>

    <div id="level-selection-container" style="display:none;">
      <p class="subtitle">è«‹ä¾åºé¸æ“‡ ç‰ˆæœ¬ â†’ å¹´ç´š â†’ èª²æ¬¡</p>
      <div class="level-tier-container">
        <div class="level-selection-column" id="version-selection-area">
          <h3 class="level-selection-title">1. é¸æ“‡ç‰ˆæœ¬</h3>
          <div class="level-buttons-wrapper"></div>
        </div>
        <div class="level-selection-column" id="grade-selection-area" style="display: none;">
          <h3 class="level-selection-title">2. é¸æ“‡å¹´ç´š</h3>
          <div class="level-buttons-wrapper"></div>
        </div>
        <div class="level-selection-column" id="lesson-selection-area" style="display: none;">
          <h3 class="level-selection-title">3. é¸æ“‡èª²æ¬¡</h3>
          <div class="level-buttons-wrapper"></div>
        </div>
      </div>
      <button id="reset-level-selection-button" style="display:none; margin-top: 15px;">é‡æ–°é¸æ“‡</button>
    </div>

    <div id="character-selection-buttons-container" style="display:none;">
      <p class="subtitle" id="character-select-subtitle" style="display:none;">é¸æ“‡è¦ç·´ç¿’çš„å­—ï¼š</p>
      <div id="character-selection-buttons">
      </div>
    </div>

    <div id="practice-mode-selector">
      <button id="normal-mode-practice-btn" class="practice-mode-button"></button>
      <button id="challenge-mode-practice-btn" class="practice-mode-button"></button>
    </div>

    <div class="display-area-container">
      <div id="animation-wrapper">
        <div id="animation-display" class="hanzi-box"></div>
        <button id="replay-animation-button" disabled></button>
      </div>
      <div id="quiz-area-wrapper">
          <div id="quiz-display" class="hanzi-box">
              <div id="reward-display-container"></div>
          </div>
          <div id="quiz-controls">
              <button id="hint-next-stroke-button" style="display: none;"></button>
          </div>
      </div>
    </div>

    <div id="practiced-characters-container">
      <h2>å·²ç·´ç¿’å­—å…ƒ</h2>
      <div id="star-count-display">
          <img src="images/star.png" alt="æ˜Ÿæ˜Ÿ" />
          <span id="stars-earned-count">0</span>
      </div>
      <div id="practiced-characters-list">
      </div>
      <a href="#progress-page" class="progress-link-button">æŸ¥çœ‹æˆ‘çš„å­¸ç¿’é€²åº¦</a>
      <a href="#links-page" class="progress-link-button" style="background-color: #607D8B; margin-left: 10px;">å¤–éƒ¨è³‡æº</a>
    </div>

  </main>
  
  <section id="progress-page">
    <div class="progress-main-layout">
    
        <div class="progress-left-column">
            <div class="progress-container">
                <h2>å­¸ç¿’é€²åº¦ç¸½è¦½</h2>
                <div id="progress-char-count-display">
                    <span class="star-icon">â˜…</span>
                    <span id="progress-char-count">0</span>
                </div>
                <p class="subtitle">ç´¯ç©ç·´ç¿’å­—æ•¸</p>
            </div>
            <div class="progress-container">
                <h2>å·²é€šé—œé—œå¡</h2>
                <div id="progress-levels-list">
                    <p class="progress-level-placeholder">å°šæœªé€šéä»»ä½•é—œå¡</p>
                </div>
            </div>
        </div>

        <div class="progress-right-column">
            <div id="progress-reward-image-container">
                </div>
        </div>
        
    </div>
    <a href="#practice-page" class="back-button">è¿”å›ç·´ç¿’</a>
  </section>
  <section id="links-page">
    <div class="links-page-content">
      <h2>å¤–éƒ¨è³‡æºé€£çµ</h2>
      <p class="subtitle">ä¸€äº›å­¸ç¿’ç¶²ç«™èˆ‡å·¥å…·</p>
      <div id="links-container">
        </div>
    </div>
    
    <a href="#home-page" class="back-button">è¿”å›é¦–é </a>
    <div id="social-links-container">
        </div>
  </section>

  <div id="congrats-overlay"></div>

  <script>
    console.log("Script block parsing started.");

    // ---- Firebase SDK CDN & Config (START) ----
    </script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
     <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <script>
    // ä½ çš„ Firebase é…ç½®ä»£ç¢¼
    const firebaseConfig = {
        apiKey: "AIzaSyCtPrLtbss8CTrYHrPLrRyVjCxk2C5IVDw",
        authDomain: "hanzi-writing-dbd3f.firebaseapp.com",
        projectId: "hanzi-writing-dbd3f",
        storageBucket: "hanzi-writing-dbd3f.firebasestorage.app",
        messagingSenderId: "24075463788",
        appId: "1:24075463788:web:3f29a7e064906e816f3c49",
        measurementId: "G-3Z38C42HGW"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const analytics = firebase.analytics();

    console.log("Firebase has been initialized successfully!");


    // ---- Firebase SDK CDN & Config (END) ----

    // ---- Global Variables ----
    let animationInstance = null;
    let quizInstance = null;
    let currentDisplayChar = null;
    let activeInputMode = 'direct';
    let practicedCharSet = new Set();
    let currentPracticeMode = 'normal';
    let numCorrectStrokesInCurrentQuiz = 0;
    let totalStrokesInCurrentChar = 0;
    let currentLevelCharacterArray = [];
    let currentLevelCharIndex = 0;
    let completedLevels = []; 
    let totalPracticedCount = 0; // âœ¨ã€æ–°å¢ã€‘ç·´ç¿’ç¸½æ¬¡æ•¸è¨ˆæ•¸å™¨

    let googleLoginButton, logoutButton, userStatusElem; 
    let userAvatarElem = document.createElement('img');
    userAvatarElem.id = 'user-avatar-display'; 
    userAvatarElem.style.display = 'none'; 

    let replayButtonElem, charSelectionContainerElem, textInputElem, textInputArea, fileInputAreaDiv,
        processDataButtonElem, directInputModeBtnElem, fileInputModeBtnElem, levelSelectModeBtnElem,
        fileInputElem, selectedFileNameDisplayElem, characterSelectSubtitleElem,
        practicedCharsListDivElem, animationWrapperElem, backgroundAudioElem,
        playPauseMusicButtonElem, inputContainerElem, levelSelectionContainerElem,
        levelButtonsAreaElem, quizAreaWrapperElem, normalModePracticeBtn, challengeModePracticeBtn,
        hintNextStrokeButton, practiceModeSelectorElem, rewardDisplayContainerElem;
        
    let allLevelsData = [];
    const masterLevelIndexFile = 'levels/master-level-index.json';
    // âœ¨ 3A. æ–°å¢ï¼šå¤–éƒ¨é€£çµè³‡æ–™é™£åˆ—
    // æœªä¾†æ‚¨åªéœ€è¦ä¿®æ”¹é€™è£¡ï¼Œå°±å¯ä»¥æ–°å¢ã€åˆªé™¤æˆ–ç·¨è¼¯é€£çµï¼
    const externalLinksData = [
        {
            title: 'åº·è»’è©¦è®€æœ¬',
            description: 'å…è²»ç´¢å–åº·è»’è®€æœ¬ã€‚',
            url: 'https://ibanana.biz/3NUZ9',
            icon: 'ğŸ“š' // æ‚¨å¯ä»¥ç”¨è¡¨æƒ…ç¬¦è™Ÿæˆ–åœ–ç‰‡
        },
        {
            title: 'åœ‹å­—æ¨™æº–å­—é«”ç­†é †å­¸ç¿’ç¶²',
            description: 'æ•™è‚²éƒ¨å®˜æ–¹çš„ç­†é †å­¸ç¿’ç¶²ç«™ã€‚',
            url: 'https://stroke-order.learningweb.moe.edu.tw/',
            icon: 'âœï¸'
        },
        {
            title: 'æˆ‘å€‘åœ¨é€™è£¡ä¸Šè‹±æ–‡',
            description: '51talk å…è²»è©¦è½',
            url: 'https://joymall.co/3NUZO',
            icon: 'ğŸ“–'
        },
        // âœ¨ 1. åœ¨é€™è£¡æ’å…¥ä¸€å€‹æ›è¡Œæ¨™è¨˜
        //{ type: 'break' },
        // âœ¨ 2. åœ¨ä¸‹é¢æ–°å¢æ‚¨æƒ³è¦çš„ç¬¬å››å€‹ã€ç¬¬äº”å€‹...é€£çµ
        //{
        //    title: 'æ–°çš„é€£çµæŒ‰éˆ•',
        //    description: 'é€™æ˜¯é¡¯ç¤ºåœ¨ç¬¬äºŒæ’çš„ç¬¬ä¸€å€‹æŒ‰éˆ•ã€‚',
        //    url: 'https://example.com',
        //    icon: 'ğŸš€'
        //}   
    ];
    // âœ¨ 3A. æ–°å¢ï¼šç¤¾ç¾¤é€£çµè³‡æ–™
    // æœªä¾†æ‚¨åªéœ€è¦ä¿®æ”¹é€™è£¡çš„ç¶²å€ï¼
    const socialLinksData = [
        {
            name: 'Facebook',
            url: 'https://www.facebook.com/bossyunlife', // <-- è«‹æ›æˆæ‚¨çš„ Facebook ç¶²å€
            icon_src: 'images/facebook_icon.png'  // <-- è«‹ç¢ºèªåœ–æª”è·¯å¾‘
        },
        {
            name: 'Instagram',
            url: 'https://www.instagram.com/agnesc629/', // <-- è«‹æ›æˆæ‚¨çš„ Instagram ç¶²å€
            icon_src: 'images/instagram_icon.png' // <-- è«‹ç¢ºèªåœ–æª”è·¯å¾‘
        }
    ];

    const musicPlaylist = [ { name: "Ukulele", path: "audio/happy-whistling-ukulele-115485.mp3" } ];
    let currentTrackIndex = 0;
    let isMusicUserInitiated = false;

// âœ¨ 1. å…¨æ–°çš„ã€Œè¦å‰‡åŒ–ã€çå‹µè¨­å®š
    const levelRewards = [
        {
            // è¦å‰‡ä¸€ï¼šç¬¦åˆæ‚¨èˆ‰ä¾‹çš„ã€Œåº·è»’ä¸€ä¸Š L1-L6ã€éš¨æ©Ÿå½±ç‰‡
            id: 'KANGXUAN_G1a_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'åº·è»’',
                grade: 'ä¸€ä¸Š',
                lessons: ['ç¬¬ä¸€èª²', 'ç¬¬äºŒèª²', 'ç¬¬ä¸‰èª²', 'ç¬¬å››èª²', 'ç¬¬äº”èª²', 'ç¬¬å…­èª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g1a/random_reward_1.mp4' },
                { type: 'video', src: 'videos/g1a/random_reward_2.mp4' },
                { type: 'video', src: 'videos/g1a/random_reward_3.mp4' }
            ]
        },
        {
            // è¦å‰‡ä¸€ï¼šç¬¦åˆæ‚¨èˆ‰ä¾‹çš„ã€Œåº·è»’ä¸€ä¸Š L1-L6ã€éš¨æ©Ÿå½±ç‰‡
            id: 'KANGXUAN_G1b1_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'åº·è»’',
                grade: 'ä¸€ä¸‹',
                lessons: ['ç¬¬ä¸€èª²', 'ç¬¬äºŒèª²', 'ç¬¬ä¸‰èª²', 'ç¬¬å››èª²', 'ç¬¬äº”èª²', 'ç¬¬å…­èª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g1b/random_reward_1.mp4' },
                { type: 'video', src: 'videos/g1b/random_reward_2.mp4' },
                { type: 'video', src: 'videos/g1b/random_reward_3.mp4' }
            ]
        },
                {
            // è¦å‰‡ä¸€ï¼šç¬¦åˆæ‚¨èˆ‰ä¾‹çš„ã€Œåº·è»’ä¸€ä¸Š L1-L6ã€éš¨æ©Ÿå½±ç‰‡
            id: 'KANGXUAN_G1b2_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'åº·è»’',
                grade: 'ä¸€ä¸‹',
                lessons: ['ç¬¬ä¸ƒèª²', 'ç¬¬å…«èª²', 'ç¬¬ä¹èª²', 'ç¬¬åèª²', 'ç¬¬åä¸€èª²', 'ç¬¬åäºŒèª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g1b/random_reward_4.mp4' },
                { type: 'video', src: 'videos/g1b/random_reward_5.mp4' },
                { type: 'video', src: 'videos/g1b/random_reward_6.mp4' }
            ]
        },
        {
            // è¦å‰‡ä¸€ï¼šç¬¦åˆæ‚¨èˆ‰ä¾‹çš„ã€Œåº·è»’ä¸€ä¸Š L1-L6ã€éš¨æ©Ÿå½±ç‰‡
            id: 'KANGXUAN_G2a1_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'åº·è»’',
                grade: 'äºŒä¸Š',
                lessons: ['ç¬¬ä¸€èª²', 'ç¬¬äºŒèª²', 'ç¬¬ä¸‰èª²', 'ç¬¬å››èª²', 'ç¬¬äº”èª²', 'ç¬¬å…­èª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g2a/random_reward_1.mp4' },
                { type: 'video', src: 'videos/g2a/random_reward_2.mp4' },
                { type: 'video', src: 'videos/g2a/random_reward_3.mp4' }
            ]
        },
                {
            id: 'KANGXUAN_G2a2_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'åº·è»’',
                grade: 'äºŒä¸Š',
                lessons: ['ç¬¬ä¸ƒèª²', 'ç¬¬å…«èª²', 'ç¬¬ä¹èª²', 'ç¬¬åèª²', 'ç¬¬åä¸€èª²', 'ç¬¬åäºŒèª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g2a/random_reward_3.mp4' },
                { type: 'video', src: 'videos/g2a/random_reward_4.mp4' },
                { type: 'video', src: 'videos/g2a/random_reward_5.mp4' },
            ]
        },   
        {
            id: 'KANGXUAN_G2b1_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'åº·è»’',
                grade: 'äºŒä¸‹',
                lessons: ['ç¬¬ä¸€èª²', 'ç¬¬äºŒèª²', 'ç¬¬ä¸‰èª²', 'ç¬¬å››èª²', 'ç¬¬äº”èª²', 'ç¬¬å…­èª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g2b/random_reward_1.mp4' },
                { type: 'video', src: 'videos/g2b/random_reward_2.mp4' },
                { type: 'video', src: 'videos/g2b/random_reward_3.mp4' }
            ]
        },
                {
            id: 'KANGXUAN_G2b2_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'åº·è»’',
                grade: 'äºŒä¸‹',
                lessons: ['ç¬¬ä¸ƒèª²', 'ç¬¬å…«èª²', 'ç¬¬ä¹èª²', 'ç¬¬åèª²', 'ç¬¬åä¸€èª²', 'ç¬¬åäºŒèª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g2b/random_reward_4.mp4' },
                { type: 'video', src: 'videos/g2b/random_reward_2.mp4' },
                { type: 'video', src: 'videos/g2b/random_reward_3.mp4' }
            ]
        },
                {
            // è¦å‰‡ä¸€ï¼šç¬¦åˆæ‚¨èˆ‰ä¾‹çš„ã€Œå—ä¸€ä¸€ä¸Š L1-L6ã€éš¨æ©Ÿå½±ç‰‡
            id: 'nan-i_G1a_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'å—ä¸€',
                grade: 'ä¸€ä¸Š',
                lessons: ['é­”æ³•æ–‡å­—','ç¬¬ä¸€èª²', 'ç¬¬äºŒèª²', 'ç¬¬ä¸‰èª²', 'ç¬¬å››èª²', 'ç¬¬äº”èª²', 'ç¬¬å…­èª²','ç¬¬ä¸ƒèª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g1a/random_reward_1.mp4' },
                { type: 'video', src: 'videos/g1a/random_reward_2.mp4' },
                { type: 'video', src: 'videos/g1a/random_reward_3.mp4' }
            ]
        },
        {
            id: 'nan-i_G1b1_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'å—ä¸€',
                grade: 'ä¸€ä¸‹',
                lessons: ['ç¬¬ä¸€èª²', 'ç¬¬äºŒèª²', 'ç¬¬ä¸‰èª²', 'ç¬¬å››èª²', 'ç¬¬äº”èª²', 'ç¬¬å…­èª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g1b/random_reward_1.mp4' },
                { type: 'video', src: 'videos/g1b/random_reward_2.mp4' },
                { type: 'video', src: 'videos/g1b/random_reward_3.mp4' }
            ]
        },
                {
            id: 'nan-i_G1b2_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'å—ä¸€',
                grade: 'ä¸€ä¸‹',
                lessons: ['ç¬¬ä¸ƒèª²', 'ç¬¬å…«èª²', 'ç¬¬ä¹èª²', 'ç¬¬åèª²', 'ç¬¬åä¸€èª²', 'ç¬¬åäºŒèª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g1b/random_reward_4.mp4' },
                { type: 'video', src: 'videos/g1b/random_reward_5.mp4' },
                { type: 'video', src: 'videos/g1b/random_reward_6.mp4' }
            ]
        },
        {
            id: 'nan-i_G2a1_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'å—ä¸€',
                grade: 'äºŒä¸Š',
                lessons: ['ç¬¬ä¸€èª²', 'ç¬¬äºŒèª²', 'ç¬¬ä¸‰èª²', 'ç¬¬å››èª²', 'ç¬¬äº”èª²', 'ç¬¬å…­èª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g2a/random_reward_1.mp4' },
                { type: 'video', src: 'videos/g2a/random_reward_2.mp4' },
                { type: 'video', src: 'videos/g2a/random_reward_3.mp4' }
            ]
        },
                {
            id: 'nan-i_G2a2_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'å—ä¸€',
                grade: 'äºŒä¸Š',
                lessons: ['ç¬¬ä¸ƒèª²', 'ç¬¬å…«èª²', 'ç¬¬ä¹èª²', 'ç¬¬åèª²', 'ç¬¬åä¸€èª²', 'ç¬¬åäºŒèª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g2a/random_reward_3.mp4' },
                { type: 'video', src: 'videos/g2a/random_reward_4.mp4' },
                { type: 'video', src: 'videos/g2a/random_reward_5.mp4' },
            ]
        },   
        {
            id: 'nan-i_G2b1_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'å—ä¸€',
                grade: 'äºŒä¸‹',
                lessons: ['ç¬¬ä¸€èª²', 'ç¬¬äºŒèª²', 'ç¬¬ä¸‰èª²', 'ç¬¬å››èª²', 'ç¬¬äº”èª²', 'ç¬¬å…­èª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g2b/random_reward_1.mp4' },
                { type: 'video', src: 'videos/g2b/random_reward_2.mp4' },
                { type: 'video', src: 'videos/g2b/random_reward_3.mp4' }
            ]
        },
                {
            id: 'nan-i_G2b2_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'å—ä¸€',
                grade: 'äºŒä¸‹',
                lessons: ['ç¬¬ä¸ƒèª²', 'ç¬¬å…«èª²', 'ç¬¬ä¹èª²', 'ç¬¬åèª²', 'ç¬¬åä¸€èª²', 'ç¬¬åäºŒèª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g2b/random_reward_4.mp4' },
                { type: 'video', src: 'videos/g2b/random_reward_2.mp4' },
                { type: 'video', src: 'videos/g2b/random_reward_3.mp4' }
            ]
        },    
               {
            // è¦å‰‡ä¸€ï¼šç¬¦åˆæ‚¨èˆ‰ä¾‹çš„ã€Œå—ä¸€ä¸€ä¸Š L1-L6ã€éš¨æ©Ÿå½±ç‰‡
            id: 'han-lin_G1a_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'ç¿°æ—',
                grade: 'ä¸€ä¸Š',
                lessons: ['ç¬¬ä¸€èª²', 'ç¬¬äºŒèª²', 'ç¬¬ä¸‰èª²', 'ç¬¬å››èª²', 'ç¬¬äº”èª²', 'ç¬¬å…­èª²','ç¬¬ä¸ƒèª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g1a/random_reward_1.mp4' },
                { type: 'video', src: 'videos/g1a/random_reward_2.mp4' },
                { type: 'video', src: 'videos/g1a/random_reward_3.mp4' }
            ]
        },
        {
            id: 'han-lin_G1b1_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'ç¿°æ—',
                grade: 'ä¸€ä¸‹',
                lessons: ['ç¬¬ä¸€èª²', 'ç¬¬äºŒèª²', 'ç¬¬ä¸‰èª²', 'ç¬¬å››èª²', 'ç¬¬äº”èª²', 'ç¬¬å…­èª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g1b/random_reward_1.mp4' },
                { type: 'video', src: 'videos/g1b/random_reward_2.mp4' },
                { type: 'video', src: 'videos/g1b/random_reward_3.mp4' }
            ]
        },
                {
            id: 'han-lin_G1b2_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'ç¿°æ—',
                grade: 'ä¸€ä¸‹',
                lessons: ['ç¬¬ä¸ƒèª²', 'ç¬¬å…«èª²', 'ç¬¬ä¹èª²', 'ç¬¬åèª²', 'ç¬¬åä¸€èª²', 'ç¬¬åäºŒèª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g1b/random_reward_4.mp4' },
                { type: 'video', src: 'videos/g1b/random_reward_5.mp4' },
                { type: 'video', src: 'videos/g1b/random_reward_6.mp4' }
            ]
        },
        {
            id: 'han-lin_G2a1_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'åº·è»’',
                grade: 'äºŒä¸Š',
                lessons: ['ç¬¬ä¸€èª²', 'ç¬¬äºŒèª²', 'ç¬¬ä¸‰èª²', 'ç¬¬å››èª²', 'ç¬¬äº”èª²', 'ç¬¬å…­èª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g2a/random_reward_1.mp4' },
                { type: 'video', src: 'videos/g2a/random_reward_2.mp4' },
                { type: 'video', src: 'videos/g2a/random_reward_3.mp4' }
            ]
        },
                {
            id: 'han-lin_G2a2_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'ç¿°æ—',
                grade: 'äºŒä¸Š',
                lessons: ['ç¬¬ä¸ƒèª²', 'ç¬¬å…«èª²', 'ç¬¬ä¹èª²', 'ç¬¬åèª²', 'ç¬¬åä¸€èª²', 'ç¬¬åäºŒèª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g2a/random_reward_3.mp4' },
                { type: 'video', src: 'videos/g2a/random_reward_4.mp4' },
                { type: 'video', src: 'videos/g2a/random_reward_5.mp4' },
            ]
        },   
        {
            id: 'han-lin_G2b1_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'ç¿°æ—',
                grade: 'äºŒä¸‹',
                lessons: ['ç¬¬ä¸€èª²', 'ç¬¬äºŒèª²', 'ç¬¬ä¸‰èª²', 'ç¬¬å››èª²', 'ç¬¬äº”èª²', 'ç¬¬å…­èª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g2b/random_reward_1.mp4' },
                { type: 'video', src: 'videos/g2b/random_reward_2.mp4' },
                { type: 'video', src: 'videos/g2b/random_reward_3.mp4' }
            ]
        },
                {
            id: 'han-lin_G2b2_INTRO', // çµ¦é€™å€‹è¦å‰‡ä¸€å€‹ç¨ç‰¹çš„åç¨±
            conditions: {
                version: 'ç¿°æ—',
                grade: 'äºŒä¸‹',
                lessons: ['ç¬¬ä¸ƒèª²', 'ç¬¬å…«èª²', 'ç¬¬ä¹èª²', 'ç¬¬åèª²', 'ç¬¬åä¸€èª²', 'ç¬¬åäºŒèª²']
            },
            rewards: [ // é€™å€‹é™£åˆ—ä¸­å¯ä»¥æ”¾å¤šå€‹çå‹µï¼Œç³»çµ±æœƒéš¨æ©ŸæŒ‘é¸ä¸€å€‹
                { type: 'video', src: 'videos/g2b/random_reward_4.mp4' },
                { type: 'video', src: 'videos/g2b/random_reward_2.mp4' },
                { type: 'video', src: 'videos/g2b/random_reward_3.mp4' }
            ]
        },    
                 
        // æ‚¨å¯ä»¥åœ¨æ­¤æ–°å¢æ›´å¤šè¦å‰‡...
    ];

    // ---- Function Definitions ----

// âœ¨ 1. æ–°å¢ï¼šå®šç¾©æ‚¨çš„æˆå°±çå‹µ
    // æ‚¨å¯ä»¥åœ¨é€™è£¡è‡ªç”±æ–°å¢åœ–ç‰‡å’Œé”æˆæ¢ä»¶
    const progressRewards = {
        // æ ¹æ“šç·´ç¿’å­—æ•¸ï¼ˆæ˜Ÿæ˜Ÿæ•¸ï¼‰çš„çå‹µ
        byStars: {
            1: { src: 'images/reward_star_10.jpg', name: 'ç·´ç¿’æ–°æ˜Ÿ' },
            30: { src: 'images/reward_star_30.jpg', name: 'æˆé•·é«˜æ‰‹' },
            60: { src: 'images/reward_star_60.jpg', name: 'è­˜å­—å¤§å¸«' },
            100: { src: 'images/reward_star_100.jpeg', name: 'å¯«å­—å¤§å¸«' },
            150: { src: 'images/reward_star_150.jpeg', name: 'å¯«å­—ç‹‚äºº' },
            200: { src: 'images/reward_star_200.jpeg', name: 'è¶…ç´šé«˜æ‰‹' },
            
        },
        byLevel: {},
        // é è¨­ï¼ˆæ²’æœ‰é”æˆä»»ä½•æˆå°±æ™‚ï¼‰é¡¯ç¤ºçš„åœ–ç‰‡
        default: { src: 'images/reward_star_10.jpg', name: 'é–‹å§‹ä½ çš„æ—…ç¨‹å§ï¼' }
    };

    // âœ¨ 2. æ–°å¢ï¼šæ›´æ–°å³å´æˆå°±åœ–ç‰‡çš„å‡½å¼
    // âœ¨ è«‹ç”¨æ­¤ç‰ˆæœ¬å®Œæ•´æ›¿æ›èˆŠçš„å‡½å¼
    function updateProgressRewardImage() {
        const imageContainer = document.getElementById('progress-reward-image-container');
        if (!imageContainer) return;

        let selectedReward = progressRewards.default; // å…ˆè¨­å®šç‚ºé è¨­çå‹µ
        let highestRewardFound = false;

        // å„ªå…ˆæª¢æŸ¥ã€Œå·²é€šé—œã€çš„çå‹µ (å¾æœ€æ–°å®Œæˆçš„é—œå¡é–‹å§‹æª¢æŸ¥)
        if (completedLevels.length > 0) {
            for (let i = completedLevels.length - 1; i >= 0; i--) {
                const levelName = completedLevels[i];
                if (progressRewards.byLevel[levelName]) {
                    selectedReward = progressRewards.byLevel[levelName];
                    highestRewardFound = true;
                    break; // æ‰¾åˆ°æœ€é«˜ç´šçš„é—œå¡çå‹µå°±åœæ­¢
                }
            }
        }
        
        // å¦‚æœæ²’æœ‰æ‰¾åˆ°ä»»ä½•é—œå¡çå‹µï¼Œå†æª¢æŸ¥ã€Œç·´ç¿’å­—æ•¸ã€çš„çå‹µ
        if (!highestRewardFound) {
            // âœ¨ã€ä¿®æ­£ã€‘å°‡ starCount çš„ä¾†æºå¾ practicedCharSet.size æ”¹ç‚º totalPracticedCount
            const starCount = totalPracticedCount;
            
            const starThresholds = Object.keys(progressRewards.byStars).map(Number).sort((a, b) => b - a); // å¾é«˜åˆ°ä½æ’åº
            
            for (const threshold of starThresholds) {
                if (starCount >= threshold) {
                    selectedReward = progressRewards.byStars[threshold];
                    break; // æ‰¾åˆ°ç¬¦åˆçš„æœ€é«˜ç´šé–€æª»å°±åœæ­¢
                }
            }
        }

        // æ›´æ–°ç•«é¢ä¸Šçš„åœ–ç‰‡å’Œæ–‡å­—
        imageContainer.innerHTML = `
            <img src="${selectedReward.src}" alt="${selectedReward.name}">
            <h3>${selectedReward.name}</h3>
            <p>æ­å–œæ‚¨é”æˆæ­¤æˆå°±ï¼</p>
        `;
    }
    // ---- Function Definitions ----

    // âœ¨ 3B. æ–°å¢ï¼šç”Ÿæˆé€£çµå¡ç‰‡çš„å‡½å¼
// âœ¨ ä¿®æ”¹ï¼šè®“å‡½å¼èƒ½è­˜åˆ¥æ›è¡Œæ¨™è¨˜
    function populateLinksPage() {
        const container = document.getElementById('links-container');
        if (!container) return;

        container.innerHTML = ''; // æ¸…ç©ºå®¹å™¨

        externalLinksData.forEach(link => {
            // æ–°å¢çš„åˆ¤æ–·ï¼šå¦‚æœç‰©ä»¶é¡å‹æ˜¯ 'break'ï¼Œå°±æ’å…¥æ›è¡Œå…ƒç´ 
            if (link.type === 'break') {
                const breakElement = `<div class="grid-row-break"></div>`;
                container.innerHTML += breakElement;
            } else {
                // å¦å‰‡ï¼Œåƒä»¥å‰ä¸€æ¨£å»ºç«‹é€£çµå¡ç‰‡
                const cardHTML = `
                    <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="link-card">
                        <div class="link-card-icon">${link.icon}</div>
                        <div class="link-card-text">
                            <h4>${link.title}</h4>
                            <p>${link.description}</p>
                        </div>
                    </a>
                `;
                container.innerHTML += cardHTML;
            }
        });
    }

    // âœ¨ 3B. æ–°å¢ï¼šç”Ÿæˆç¤¾ç¾¤é€£çµåœ–ç¤ºçš„å‡½å¼
    function populateSocialLinks() {
        const container = document.getElementById('social-links-container');
        if (!container) return;

        container.innerHTML = ''; // æ¸…ç©ºå®¹å™¨

        socialLinksData.forEach(link => {
            const linkHTML = `
                <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="social-link" title="${link.name}">
                    <img src="${link.icon_src}" alt="${link.name} Icon">
                </a>
            `;
            container.innerHTML += linkHTML;
        });
    }


    // æ–°å¢ï¼šæ›´æ–°é€²åº¦é é¢(å·¦å´)çš„å‡½å¼
    function updateProgressPage() {
        const charCountElem = document.getElementById('progress-char-count');
        const levelsListElem = document.getElementById('progress-levels-list');

        if (charCountElem) {
            charCountElem.textContent = totalPracticedCount;
        }

        if (levelsListElem) {
            levelsListElem.innerHTML = ''; // æ¸…ç©ºèˆŠåˆ—è¡¨
            if (completedLevels.length > 0) {
                completedLevels.forEach(levelName => {
                    const levelItem = document.createElement('div');
                    levelItem.classList.add('progress-level-item');
                    levelItem.textContent = levelName;
                    levelsListElem.appendChild(levelItem);
                });
            } else {
                // å¦‚æœæ²’æœ‰å·²é€šé—œçš„é—œå¡ï¼Œé¡¯ç¤ºæç¤ºæ–‡å­—
                levelsListElem.innerHTML = '<p class="progress-level-placeholder">å°šæœªé€šéä»»ä½•é—œå¡</p>';
            }
        }
    }


    function initializeDOMReferences() {
        replayButtonElem = document.getElementById('replay-animation-button');
        charSelectionContainerElem = document.getElementById('character-selection-buttons');
        textInputElem = document.getElementById('text-input');
        textInputArea = document.getElementById('text-input-area');
        fileInputAreaDiv = document.getElementById('file-input-area');
        processDataButtonElem = document.getElementById('process-data-button');
        directInputModeBtnElem = document.getElementById('direct-input-mode-btn');
        fileInputModeBtnElem = document.getElementById('file-input-mode-btn');
        levelSelectModeBtnElem = document.getElementById('level-select-mode-btn');
        fileInputElem = document.getElementById('file-input');
        selectedFileNameDisplayElem = document.getElementById('selected-file-name');
        characterSelectSubtitleElem = document.getElementById('character-select-subtitle');
        practicedCharsListDivElem = document.getElementById('practiced-characters-list');
        animationWrapperElem = document.getElementById('animation-wrapper');
        backgroundAudioElem = document.getElementById('background-audio');
        playPauseMusicButtonElem = document.getElementById('play-pause-music-button');
        normalModePracticeBtn = document.getElementById('normal-mode-practice-btn');
        challengeModePracticeBtn = document.getElementById('challenge-mode-practice-btn');
        hintNextStrokeButton = document.getElementById('hint-next-stroke-button');
        inputContainerElem = document.getElementById('input-container');
        levelSelectionContainerElem = document.getElementById('level-selection-container');
        levelButtonsAreaElem = document.getElementById('level-buttons-area');
        quizAreaWrapperElem = document.getElementById('quiz-area-wrapper');
        practiceModeSelectorElem = document.getElementById('practice-mode-selector');
        rewardDisplayContainerElem = document.getElementById('reward-display-container');
        
        googleLoginButton = document.getElementById('google-login-button');
        logoutButton = document.getElementById('logout-button');
        userStatusElem = document.getElementById('user-status'); 
        userStatusElem.prepend(userAvatarElem); 
        document.getElementById('reset-level-selection-button').onclick = resetLevelSelection;        
    }

    function setupEventListeners() {
        try {
            if (normalModePracticeBtn) normalModePracticeBtn.onclick = () => setPracticeMode('normal');
            if (challengeModePracticeBtn) challengeModePracticeBtn.onclick = () => setPracticeMode('challenge');
            if (processDataButtonElem) processDataButtonElem.onclick = processInputData;
            if (directInputModeBtnElem) directInputModeBtnElem.onclick = () => setActiveInputMode('direct');
            if (fileInputModeBtnElem) fileInputModeBtnElem.onclick = () => setActiveInputMode('file');
            if (levelSelectModeBtnElem) levelSelectModeBtnElem.onclick = () => setActiveInputMode('level');
            if (fileInputElem) fileInputElem.onchange = updateSelectedFileName;
            if (replayButtonElem) replayButtonElem.onclick = replayAnimation;
            if (hintNextStrokeButton) {
                hintNextStrokeButton.onclick = function() {
                    if (quizInstance && (currentPracticeMode === 'challenge' || activeInputMode === 'level_practice')) {
                        if (typeof quizInstance.highlightStroke === 'function' && totalStrokesInCurrentChar > 0) {
                            const nextStrokeToHint = numCorrectStrokesInCurrentQuiz;
                            if (nextStrokeToHint < totalStrokesInCurrentChar) {
                                quizInstance.highlightStroke(nextStrokeToHint, { duration: 1200, color: '#FFD700' });
                            } else {
                                alert("å¤ªæ£’äº†ï¼Œæ‰€æœ‰ç­†åŠƒå‡å·²æ­£ç¢ºå®Œæˆï¼");
                            }
                        } else {
                            alert("ç„¡æ³•æä¾›æç¤ºåŠŸèƒ½ (E-H04)ã€‚");
                        }
                    }
                };
            }
            setupMusicControls();

            if (googleLoginButton) {
                googleLoginButton.addEventListener('click', async () => {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    try {
                        await auth.signInWithPopup(provider);
                    } catch (error) {
                        console.error("Google ç™»å…¥å¤±æ•—:", error.message);
                        userStatusElem.textContent = "ç™»å…¥å¤±æ•—: " + error.message;
                        userAvatarElem.style.display = 'none';
                    }
                });
            }

            if (logoutButton) {
                logoutButton.addEventListener('click', async () => {
                    try {
                        await auth.signOut();
                    } catch (error) {
                        console.error("ç™»å‡ºå¤±æ•—:", error.message);
                    }
                });
            }

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    userStatusElem.textContent = `${user.displayName || user.email}`;
                    userAvatarElem.src = user.photoURL || '';
                    userAvatarElem.alt = user.displayName || 'User Avatar';
                    userAvatarElem.style.display = 'inline-block';

                    googleLoginButton.style.display = 'none';
                    logoutButton.style.display = 'block';

                    const userDocRef = db.collection('users').doc(user.uid);
                    try {
                        const doc = await userDocRef.get();
                        if (doc.exists) {
                            const userData = doc.data();
                            completedLevels = userData.completedLevels || [];
                            practicedCharSet = new Set(userData.practicedChars || []);
                            totalPracticedCount = userData.totalPracticedCount || 0; 
                            console.log("ç”¨æˆ¶æ•¸æ“šå·²è¼‰å…¥:", userData);
                        } else {
                            await userDocRef.set({
                                completedLevels: [],
                                practicedChars: [],
                                totalPracticedCount: 0,
                                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            completedLevels = [];
                            practicedCharSet = new Set();
                            console.log("æ–°ç”¨æˆ¶æ•¸æ“šå·²å»ºç«‹ã€‚");
                        }
                    } catch (error) {
                        console.error("è¼‰å…¥æˆ–åˆå§‹åŒ–ç”¨æˆ¶æ•¸æ“šå¤±æ•—:", error);
                        completedLevels = [];
                        practicedCharSet = new Set();
                    } finally {
                        updatePracticedCharactersDisplay();
                        //populateLevelSelectionUI();//
                        updateProgressPage(); // âœ¨ æ›´æ–°é€²åº¦é é¢
                        updateProgressRewardImage(); 
                    }

                } else {
                    userStatusElem.textContent = 'è«‹ç™»å…¥ä»¥ä¿å­˜ä½ çš„é€²åº¦ã€‚';
                    userAvatarElem.style.display = 'none';

                    googleLoginButton.style.display = 'block';
                    logoutButton.style.display = 'none';

                    completedLevels = [];
                    practicedCharSet = new Set();
                    totalPracticedCount = 0; 
                    updatePracticedCharactersDisplay();
                    //populateLevelSelectionUI();//
                    updateProgressPage(); // âœ¨ æ›´æ–°é€²åº¦é é¢
                    updateProgressRewardImage(); 

                    localStorage.removeItem('completedLevels');
                    localStorage.removeItem('practicedCharSet');
                }
            });

        } catch (error) {
            console.error("Error during setupEventListeners:", error);
        }
    }

    function initializeAppState() {
            try {
                directInputModeBtnElem.textContent = 'è¼¸å…¥ä½ æƒ³ç·´çš„å­—';
                fileInputModeBtnElem.textContent = 'åŒ¯å…¥æª”æ¡ˆ';
                levelSelectModeBtnElem.textContent = 'æŒ‘æˆ°å°å­¸é—œå¡';
                processDataButtonElem.textContent = 'è™•ç†è³‡æ–™';
                replayButtonElem.textContent = 'ä¾†çœ‹çœ‹ç­†é †å§';
                normalModePracticeBtn.textContent = 'ä¸€èˆ¬è‡¨æ‘¹';
                challengeModePracticeBtn.textContent = 'æŒ‘æˆ°æ¨¡å¼';
                hintNextStrokeButton.textContent = 'æç¤ºä¸‹ä¸€ç­†';

                setupMusicControls();
                setActiveInputMode('direct');
                setPracticeMode('normal');

                loadLevelData();
                if(animationWrapperElem) {
                    animationWrapperElem.style.display = 'none';
                }
            } catch (error) {
                console.error("Error during initializeAppState:", error);
            }
        }

// æ–°å¢ï¼šç”¨æ–¼å„²å­˜é—œå¡é¸æ“‡ç‹€æ…‹çš„è®Šæ•¸
    let masterLevelData = null;
    let selectedVersion = null;
    let selectedGrade = null;

    // ä¿®æ”¹å¾Œçš„ loadLevelData å‡½å¼
    async function loadLevelData() {
        try {
            // ç¾åœ¨åªæœƒè¼‰å…¥ä¸»ç´¢å¼•æª”æ¡ˆ
            const response = await fetch(masterLevelIndexFile);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            masterLevelData = await response.json();
            // è¼‰å…¥æˆåŠŸå¾Œï¼Œç”Ÿæˆç¬¬ä¸€å±¤UI (ç‰ˆæœ¬é¸æ“‡)
            populateVersionUI(); 
        } catch (error) {
            alert("è¼‰å…¥é—œå¡ä¸»ç´¢å¼•æª”æ¡ˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆè·¯å¾‘æˆ–å…§å®¹ã€‚");
            console.error("Error loading master level index:", error);
        }
    }

    // æ–°å¢ï¼šç”Ÿæˆã€Œç‰ˆæœ¬ã€é¸é …çš„å‡½å¼
    function populateVersionUI() {
        const container = document.querySelector('#version-selection-area .level-buttons-wrapper');
        container.innerHTML = '';
        if (!masterLevelData) return;

        Object.keys(masterLevelData).forEach(versionName => {
            const button = createTierButton(versionName, () => {
                selectedVersion = versionName;
                // æ›´æ–°æŒ‰éˆ•é¸ä¸­ç‹€æ…‹
                document.querySelectorAll('#version-selection-area .tier-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // é¡¯ç¤ºä¸‹ä¸€å±¤ä¸¦éš±è—æ›´å¾Œé¢çš„å±¤ç´š
                document.getElementById('grade-selection-area').style.display = 'block';
                document.getElementById('lesson-selection-area').style.display = 'none';
                document.getElementById('reset-level-selection-button').style.display = 'inline-block';
                populateGradeUI(); // ç”Ÿæˆå¹´ç´šé¸é …
            });
            container.appendChild(button);
        });
    }

    // æ–°å¢ï¼šç”Ÿæˆã€Œå¹´ç´šã€é¸é …çš„å‡½å¼
    function populateGradeUI() {
        const container = document.querySelector('#grade-selection-area .level-buttons-wrapper');
        container.innerHTML = '';
        const grades = masterLevelData[selectedVersion];

        Object.keys(grades).forEach(gradeName => {
            const button = createTierButton(gradeName, () => {
                selectedGrade = gradeName;
                document.querySelectorAll('#grade-selection-area .tier-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                document.getElementById('lesson-selection-area').style.display = 'block';
                populateLessonUI(); // ç”Ÿæˆèª²æ¬¡é¸é …
            });
            container.appendChild(button);
        });
    }

    // æ–°å¢ï¼šç”Ÿæˆã€Œèª²æ¬¡ã€é¸é …çš„å‡½å¼
    function populateLessonUI() {
        const container = document.querySelector('#lesson-selection-area .level-buttons-wrapper');
        container.innerHTML = '';
        const lessons = masterLevelData[selectedVersion][selectedGrade];

        Object.keys(lessons).forEach(lessonName => {
            const button = createTierButton(lessonName, async () => {
                const lessonFilePath = lessons[lessonName];
                try {
                    // ç›´åˆ°æœ€å¾Œä¸€æ­¥æ‰çœŸæ­£å»è¼‰å…¥èª²æ¬¡çš„JSONæª”æ¡ˆ
                    const response = await fetch(lessonFilePath);
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const lessonData = await response.json();
                    currentActiveLevelData = { 
                        levelName: `${selectedVersion} - ${selectedGrade} - ${lessonName}` 
                    };                    
                    // æˆåŠŸå–å¾—èª²æ¬¡è³‡æ–™ï¼Œé–‹å§‹ç·´ç¿’
                    setActiveInputMode('level_practice');
                    currentLevelCharacterArray = lessonData.characters;
                    currentLevelCharIndex = 0;
                    if (currentLevelCharacterArray.length > 0) {
                        startLevelCharacterPractice(currentLevelCharacterArray[0]);
                    } else {
                        alert(`èª²æ¬¡ "${lessonName}" ä¸­æ²’æœ‰å­—å…ƒã€‚`);
                        resetLevelSelection();
                    }

                } catch (error) {
                    alert(`è¼‰å…¥èª²æ¬¡æª”æ¡ˆ "${lessonName}" å¤±æ•—ã€‚`);
                    console.error("Error loading lesson file:", error);
                }
            });
            container.appendChild(button);
        });
    }

    // æ–°å¢ï¼šå»ºç«‹é¸é …æŒ‰éˆ•çš„è¼”åŠ©å‡½å¼
    function createTierButton(text, onClick) {
        const button = document.createElement('button');
        button.classList.add('tier-button');
        button.textContent = text;
        button.onclick = onClick;
        return button;
    }

    // æ–°å¢ï¼šé‡ç½®æ‰€æœ‰é—œå¡é¸æ“‡çš„è¼”åŠ©å‡½å¼
    function resetLevelSelection() {
        selectedVersion = null;
        selectedGrade = null;
        document.getElementById('version-selection-area').querySelectorAll('.tier-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('grade-selection-area').style.display = 'none';
        document.getElementById('lesson-selection-area').style.display = 'none';
        document.getElementById('reset-level-selection-button').style.display = 'none';
    }
    function startLevelCharacterPractice(char) {
        if (!char) {
            handleLevelCompletion(currentActiveLevelData); 
            return;
        }
        currentDisplayChar = char;
        if (animationWrapperElem) animationWrapperElem.style.display = 'flex';
        
        const animBoxElement = document.getElementById('animation-display');
        if (animBoxElement) {
            // âœ¨ã€ä¿®æ”¹ STARTã€‘
            // 1. å–å¾— SVG æ ¼ç·šç¯„æœ¬çš„ HTML å…§å®¹
            const gridTemplate = document.getElementById('hanzi-grid-template').outerHTML;

            // 2. å°‡å‹•ç•«æ¡†çš„å…§å®¹è¨­å®šç‚ºæˆ‘å€‘çš„æ ¼ç·š
            animBoxElement.innerHTML = gridTemplate.replace('id="hanzi-grid-template"', 'id="animation-grid-svg"');
            // âœ¨ã€ä¿®æ”¹ ENDã€‘
            
            // âœ¨ã€ä¿®æ”¹ã€‘å°‡ HanziWriter çš„ç›®æ¨™å¾ div æ”¹ç‚º SVG çš„ ID
            animationInstance = HanziWriter.create('animation-grid-svg', char, {
                padding: 10,
                strokeColor: '#000000', 
                showCharacter: true, 
                showOutline: false
            });

            if (replayButtonElem) replayButtonElem.disabled = false;
            animationInstance.animateCharacter();
        }
        createQuizInstance(char);
    }
    function setActiveInputMode(mode) {
        activeInputMode = mode;

        if (animationWrapperElem) animationWrapperElem.style.display = 'none';

        const quizBox = document.getElementById('quiz-display');
        if (quizBox) {
            const svg = quizBox.querySelector('svg:not(#congrats-overlay svg)');
            if (svg) svg.remove();
        }

        hideAllRewards();

        const charContainer = document.getElementById('character-selection-buttons-container');
        if (charContainer) charContainer.style.display = 'none';
        if (charSelectionContainerElem) charSelectionContainerElem.innerHTML = '';

        // âœ¨ã€ä¿®æ­£ã€‘å¢åŠ  typeof æª¢æŸ¥ï¼Œç¢ºä¿ cleanup æ˜¯å€‹å‡½å¼æ‰å‘¼å«
        if (quizInstance && typeof quizInstance.cleanup === 'function') {
            quizInstance.cleanup();
        }
        if (animationInstance && typeof animationInstance.cleanup === 'function') {
            animationInstance.cleanup();
        }
        quizInstance = null;
        animationInstance = null;
        currentDisplayChar = null;

        if (!directInputModeBtnElem || !inputContainerElem || !levelSelectionContainerElem) return;

        directInputModeBtnElem.classList.toggle('active', mode === 'direct');
        fileInputModeBtnElem.classList.toggle('active', mode === 'file');
        levelSelectModeBtnElem.classList.toggle('active', mode === 'level' || mode === 'level_practice');

        inputContainerElem.style.display = (mode === 'direct' || mode === 'file') ? 'flex' : 'none';
        levelSelectionContainerElem.style.display = (mode === 'level') ? 'flex' : 'none';

        const isCustomMode = (mode === 'direct' || mode === 'file');
        const isLevelMode = (mode === 'level' || mode === 'level_practice');

        if(practiceModeSelectorElem) {
            practiceModeSelectorElem.style.display = isLevelMode ? 'none' : 'flex';
        }

        if (isCustomMode) {
            if (characterSelectSubtitleElem) characterSelectSubtitleElem.style.display = 'none';
            if (mode === 'direct') showDirectInputModeInternal(); else showFileUploadModeInternal();
        }
        if (mode === 'level') {
            resetLevelSelection(); 
        }
    }

    function showDirectInputModeInternal() {
        if(textInputArea) textInputArea.style.display = 'flex';
        if(fileInputAreaDiv) fileInputAreaDiv.style.display = 'none';
    }
    function showFileUploadModeInternal() {
        if(textInputArea) textInputArea.style.display = 'none';
        if(fileInputAreaDiv) fileInputAreaDiv.style.display = 'flex';
    }

    function updateSelectedFileName() {
        if (fileInputElem?.files.length > 0) { if (selectedFileNameDisplayElem) selectedFileNameDisplayElem.textContent = `å·²é¸æª”æ¡ˆ: ${fileInputElem.files[0].name}`; }
        else { if (selectedFileNameDisplayElem) selectedFileNameDisplayElem.textContent = ''; }
    }

    function processInputData() {
      try {
        const charContainer = document.getElementById('character-selection-buttons-container');
        if (charContainer) {
            charContainer.style.display = 'none';
        }

        if(charSelectionContainerElem) charSelectionContainerElem.innerHTML = '';
        
        // âœ¨ã€ä¿®æ­£ã€‘å¢åŠ  typeof æª¢æŸ¥
        if (animationInstance && typeof animationInstance.cleanup === 'function') {
            animationInstance.cleanup();
        }
        if (quizInstance && typeof quizInstance.cleanup === 'function') {
            quizInstance.cleanup();
        }
        animationInstance = null; 
        quizInstance = null; 
        currentDisplayChar = null;
        
        if(replayButtonElem) replayButtonElem.disabled = true;
        if (animationWrapperElem) animationWrapperElem.style.display = 'none';

        const quizBox = document.getElementById('quiz-display');
        if (quizBox) {
            const svg = quizBox.querySelector('svg:not(#congrats-overlay svg)');
            if (svg) svg.remove();
        }

        if (characterSelectSubtitleElem) characterSelectSubtitleElem.style.display = 'none';
        if (hintNextStrokeButton) hintNextStrokeButton.style.display = 'none';
        numCorrectStrokesInCurrentQuiz = 0; totalStrokesInCurrentChar = 0;
        if (activeInputMode === 'direct') {
            if (!textInputElem) { alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æ–‡å­—è¼¸å…¥æ¡†å…ƒä»¶ï¼"); return; }
            const text = textInputElem.value.trim();
            if (text.length > 0) generateCharacterButtons(text); else alert("è«‹è¼¸å…¥æ–‡å­—ï¼");
        } else if (activeInputMode === 'file') {
            if (!fileInputElem || !fileInputElem.files || fileInputElem.files.length === 0) { alert("è«‹é¸æ“‡ä¸€å€‹æª”æ¡ˆï¼"); return; }
            const file = fileInputElem.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function(e) { generateCharacterButtons(e.target.result); };
              reader.onerror = function() { alert("è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚"); };
              reader.readAsText(file, 'UTF-8');
            }
        }
      } catch (error) { console.error("Error in processInputData:", error); }
    }

    function generateCharacterButtons(text) {
      try {
        const uniqueChars = [...new Set(text.replace(/[^\u4e00-\u9fa5]/g, ''))];
        if(charSelectionContainerElem) charSelectionContainerElem.innerHTML = '';
        if (uniqueChars.length > 0) {
            const charContainer = document.getElementById('character-selection-buttons-container');
            if (charContainer) {
                charContainer.style.display = 'block';
            }

            if (characterSelectSubtitleElem) characterSelectSubtitleElem.style.display = 'block';
            if (charSelectionContainerElem) charSelectionContainerElem.style.display = 'flex';
            uniqueChars.forEach(char => {
            const button = document.createElement('button');
            button.classList.add('char-select-button');
            button.textContent = char;
            button.onclick = function() {
                document.querySelectorAll('.char-select-button.active').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                displayCharacterInBothModes(char);
            };
            if(charSelectionContainerElem) charSelectionContainerElem.appendChild(button);
            });
        } else {
            alert("æœªåœ¨è¼¸å…¥ä¸­æ‰¾åˆ°æœ‰æ•ˆçš„ä¸­æ–‡å­—å…ƒé€²è¡Œç·´ç¿’ï¼");
        }
      } catch (error) { console.error("Error in generateCharacterButtons:", error); }
    }

    function setPracticeMode(mode) {
        currentPracticeMode = mode;
        if (!normalModePracticeBtn || !challengeModePracticeBtn || !hintNextStrokeButton) return;
        normalModePracticeBtn.classList.toggle('active', mode === 'normal');
        challengeModePracticeBtn.classList.toggle('active', mode === 'challenge');
        let showHint = (mode === 'challenge' && quizInstance && currentDisplayChar);
        if (activeInputMode === 'level_practice') { showHint = false; }
        hintNextStrokeButton.style.display = showHint ? 'inline-block' : 'none';
        if (currentDisplayChar && quizInstance) { createQuizInstance(currentDisplayChar); }
    }

    function createQuizInstance(char) {
        const quizBox = document.getElementById('quiz-display');
        if (!quizBox) return;

        // âœ¨ã€ä¿®æ”¹ STARTã€‘
        // 1. å–å¾— SVG æ ¼ç·šç¯„æœ¬çš„ HTML å…§å®¹
        const gridTemplate = document.getElementById('hanzi-grid-template').outerHTML;
        
        // 2. å°‡è‡¨æ‘¹æ¡†çš„å…§å®¹è¨­å®šç‚ºæˆ‘å€‘çš„æ ¼ç·šã€‚æˆ‘å€‘çµ¦é€™å€‹æ ¼ç·šä¸€å€‹æ–°çš„ã€ç¨ç«‹çš„ IDã€‚
        quizBox.innerHTML = gridTemplate.replace('id="hanzi-grid-template"', 'id="quiz-grid-svg"');
        // âœ¨ã€ä¿®æ”¹ ENDã€‘

        const options = {
            padding: 20,
            strokeColor: '#000000', 
            drawingColor: '#333333',
            highlightOnComplete: true,
            onLoadCharDataSuccess: function(charDataObj) {
                if (quizInstance?.quiz) {
                    quizInstance.quiz({
                        onCorrectStroke: () => {},
                        onComplete: () => {
                            totalPracticedCount++;
                            practicedCharSet.add(char);
                            updatePracticedCharactersDisplay();
                            updateProgressPage();
                            updateProgressRewardImage();
                            saveUserDataToFirebase({ 
                                practicedChars: Array.from(practicedCharSet),
                                totalPracticedCount: totalPracticedCount
                            });
                            if (activeInputMode === 'level_practice') {
                                currentLevelCharIndex++;
                                setTimeout(() => startLevelCharacterPractice(currentLevelCharacterArray[currentLevelCharIndex]), 500);
                            }
                        }
                    });
                }
            }
        };

        if (currentPracticeMode === 'challenge' || activeInputMode === 'level_practice') {
            options.showOutline = false;
        } else {
            options.showOutline = true;
            options.outlineColor = '#DDDDDD';
        }
        
        // âœ¨ã€ä¿®æ”¹ã€‘å°‡ HanziWriter çš„ç›®æ¨™å¾ div æ”¹ç‚ºæˆ‘å€‘å‰›å‰›å»ºç«‹çš„ SVG çš„ ID
        quizInstance = HanziWriter.create('quiz-grid-svg', char, options);
    }

    function displayCharacterInBothModes(char) {
      try {
        currentDisplayChar = char;
        if (animationWrapperElem) animationWrapperElem.style.display = 'flex';
        if (practiceModeSelectorElem) practiceModeSelectorElem.style.display = 'flex';
        
        const animBoxElement = document.getElementById('animation-display');
        const quizBoxElement = document.getElementById('quiz-display');

        if(animBoxElement) animBoxElement.innerHTML = '';
        if(quizBoxElement){
            const hanziWriterSVG = quizBoxElement.querySelector('svg:not(#congrats-overlay svg)');
            if (hanziWriterSVG) hanziWriterSVG.remove();
        }

        // âœ¨ã€ä¿®æ­£ã€‘å¢åŠ  typeof æª¢æŸ¥
        if (animationInstance && typeof animationInstance.cleanup === 'function') {
            animationInstance.cleanup();
        }
        if (quizInstance && typeof quizInstance.cleanup === 'function') {
            quizInstance.cleanup();
        }
        animationInstance = null; 
        quizInstance = null;

        numCorrectStrokesInCurrentQuiz = 0; 
        totalStrokesInCurrentChar = 0;
        if(replayButtonElem) replayButtonElem.disabled = true;
        if (hintNextStrokeButton) { hintNextStrokeButton.style.display = 'none'; hintNextStrokeButton.disabled = true; }

        if (animBoxElement) {
            const gridTemplate = document.getElementById('hanzi-grid-template').outerHTML;
            animBoxElement.innerHTML = gridTemplate.replace('id="hanzi-grid-template"', 'id="animation-grid-svg"');
            
            animationInstance = HanziWriter.create('animation-grid-svg', char, {
                strokeColor: '#000000', 
                showCharacter: true, 
                showOutline: false,
                strokeAnimationSpeed: 0.6, 
                delayBetweenStrokes: 80, 
                autoAnimate: false,
                onLoadCharDataSuccess: function() { 
                    if (animationInstance) { 
                        animationInstance.animateCharacter(); 
                        if(replayButtonElem) replayButtonElem.disabled = false;
                    }
                },
            });

            if (!animationInstance && replayButtonElem) { replayButtonElem.disabled = true; }
        }
        createQuizInstance(char);
      } catch (error) { console.error("Error in displayCharacterInBothModes for " + char + ":", error); }
    }

    function replayAnimation() { if (animationInstance) { animationInstance.animateCharacter();}}
    function updatePracticedCharactersDisplay() {
        if (!practicedCharsListDivElem) return;
        practicedCharsListDivElem.innerHTML = '';
        if (practicedCharSet.size === 0) { practicedCharsListDivElem.textContent = 'å°šæœªç·´ç¿’ä»»ä½•å­—å…ƒã€‚'; return;}
        const charsArray = Array.from(practicedCharSet);
        charsArray.forEach(practicedChar => {
            const charSpan = document.createElement('span');
            charSpan.classList.add('practiced-char-item');
            charSpan.textContent = practicedChar;
            practicedCharsListDivElem.appendChild(charSpan);});
    }
// âœ¨ 2. å…¨æ–°çš„ã€Œçå‹µæœå°‹ã€å‡½å¼
    function findRewardForLevel(levelName) {
        if (!levelName) return null;

        // å°‡ "åº·è»’ - ä¸€å¹´ç´š - ç¬¬ä¸€èª²" é€™æ¨£çš„åç¨±æ‹†è§£æˆä¸‰å€‹éƒ¨åˆ†
        const parts = levelName.split(' - ');
        if (parts.length < 3) return null;
        
        const currentVersion = parts[0];
        const currentGrade = parts[1];
        const currentLesson = parts[2];

        // éæ­·æ‰€æœ‰çå‹µè¦å‰‡
        for (const rule of levelRewards) {
            const cond = rule.conditions;
            // æª¢æŸ¥ç‰ˆæœ¬ã€å¹´ç´šã€èª²æ¬¡æ˜¯å¦éƒ½ç¬¦åˆè¦å‰‡
            const versionMatch = cond.version === currentVersion;
            const gradeMatch = cond.grade === currentGrade;
            const lessonMatch = cond.lessons.includes(currentLesson);

            if (versionMatch && gradeMatch && lessonMatch) {
                return rule.rewards; // æ‰¾åˆ°ç¬¦åˆçš„è¦å‰‡ï¼Œè¿”å›å…¶çå‹µé™£åˆ—
            }
        }

        return null; // å¦‚æœæ²’æœ‰ä»»ä½•è¦å‰‡ç¬¦åˆï¼Œè¿”å› null
    }
// âœ¨ 3. ä¿®æ”¹é€šé—œå‹•ç•«å‡½å¼ä»¥æ”¯æ´éš¨æ©Ÿæ’­æ”¾
    function playLevelCompletionAnimation(levelData) {
        const overlay = document.getElementById('congrats-overlay');
        if (!overlay || !levelData || !levelData.levelName) return;

        // ä½¿ç”¨æ–°çš„æœå°‹å‡½å¼ä¾†å°‹æ‰¾ç¬¦åˆæ¢ä»¶çš„çå‹µæ±  (ä¸€å€‹é™£åˆ—)
        const rewardPool = findRewardForLevel(levelData.levelName);

        // æª¢æŸ¥æ˜¯å¦æ‰¾åˆ°äº†çå‹µæ± ï¼Œä¸”æ± ä¸­æœ‰çå‹µ
        if (!rewardPool || rewardPool.length === 0) {
            console.log(`æ²’æœ‰ç‚ºé—œå¡ "${levelData.levelName}" è¨­å®šä»»ä½•çå‹µã€‚`);
            // å³ä½¿æ²’æœ‰å½±ç‰‡ï¼Œä¹Ÿé¡¯ç¤ºæ­å–œè¨Šæ¯ä¸¦æ­£å¸¸è¿”å›
            overlay.innerHTML = `<h2>æ­å–œï¼æ‚¨å·²å®Œæˆ ${levelData.levelName}ï¼</h2>`;
            overlay.style.display = 'flex';
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                    setActiveInputMode('level');
                }, 500);
            }, 3000);
            return; // æå‰çµæŸå‡½å¼
        }

        // å¾çå‹µæ± ä¸­éš¨æ©ŸæŒ‘é¸ä¸€å€‹çå‹µ
        const selectedReward = rewardPool[Math.floor(Math.random() * rewardPool.length)];

        // --- å¾ŒçºŒçš„é¡¯ç¤ºé‚è¼¯èˆ‡ä¹‹å‰é¡ä¼¼ ---
        const DESIRED_PLAY_COUNT = 1; // é è¨­æ’­æ”¾ä¸€æ¬¡ï¼Œæ‚¨å¯ä»¥èª¿æ•´
        let content = `<h2>æ­å–œï¼æ‚¨å·²å®Œæˆ ${levelData.levelName}ï¼</h2>`;

        if (selectedReward && selectedReward.src) {
            if (selectedReward.type === 'video') {
                content += `<video src="${selectedReward.src}" autoplay muted playsinline class="congrats-image"></video>`;
            } else {
                content += `<img src="${selectedReward.src}" alt="å®Œæˆçå‹µ" class="congrats-image">`;
            }
        }

        overlay.innerHTML = content;
        
        const videoElement = overlay.querySelector('video');
        if (videoElement) {
            let playCount = 0; 
            videoElement.addEventListener('ended', () => {
                playCount++;
                if (playCount < DESIRED_PLAY_COUNT) {
                    videoElement.play();
                } else {
                    fadeOutAndHide();
                }
            });
        } else {
             // å¦‚æœæ˜¯åœ–ç‰‡ï¼Œå‰‡å›ºå®šæ™‚é–“å¾Œæ¶ˆå¤±
             setTimeout(fadeOutAndHide, 4000);
        }

        function fadeOutAndHide() {
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
                setActiveInputMode('level');
            }, 500);
        }

        overlay.style.display = 'flex';
        setTimeout(() => {
            overlay.style.opacity = '1';
        }, 10);
    }

    function handleLevelCompletion(levelData) {
        if (!levelData || !levelData.levelName) return;
        if (!completedLevels.includes(levelData.levelName)) {
            completedLevels.push(levelData.levelName);
            saveUserDataToFirebase({ completedLevels: completedLevels });
            updateProgressPage(); 
            updateProgressRewardImage();
        }
        playLevelCompletionAnimation(levelData);
    }

    async function saveUserDataToFirebase(dataToSave) {
        if (auth.currentUser) {
            const userDocRef = db.collection('users').doc(auth.currentUser.uid);
            try {
                await userDocRef.set(dataToSave, { merge: true });
                console.log("ç”¨æˆ¶æ•¸æ“šå·²ä¿å­˜åˆ° Firebase:", dataToSave);
            } catch (error) {
                console.error("ä¿å­˜ç”¨æˆ¶æ•¸æ“šåˆ° Firebase å¤±æ•—:", error);
            }
        } else {
            console.warn("ç”¨æˆ¶æœªç™»å…¥ï¼Œæ•¸æ“šç„¡æ³•ä¿å­˜åˆ° Firebaseã€‚");
        }
    }

    function showReward(rewardIdentifier, rewardType) {
        if (!rewardDisplayContainerElem) return;
        let reward = levelRewards[rewardIdentifier];

        if (!reward) { rewardDisplayContainerElem.style.display = 'none'; return; }

        rewardDisplayContainerElem.innerHTML = '';
        rewardDisplayContainerElem.style.width = reward.size || '150px';
        if (reward.type === 'image') {
            const img = document.createElement('img');
            img.src = reward.src;
            img.alt = `å®Œæˆçå‹µ`;
            img.onerror = () => { rewardDisplayContainerElem.innerHTML = '<p style="color:red;font-size:12px;">çå‹µåœ–ç‰‡è¼‰å…¥å¤±æ•—</p>'; };
            rewardDisplayContainerElem.appendChild(img);
        }
        rewardDisplayContainerElem.style.display = 'block';

        rewardDisplayContainerElem.style.transform = 'translateY(100%) translateX(100%)';
        rewardDisplayContainerElem.style.opacity = '0';
        setTimeout(() => {
            rewardDisplayContainerElem.style.transition = 'transform 0.5s ease-out, opacity 0.5s ease-out';
            rewardDisplayContainerElem.style.transform = 'translateY(-10px) translateX(-10px)';
            rewardDisplayContainerElem.style.opacity = '1';
        }, 50);

        setTimeout(() => {
            rewardDisplayContainerElem.style.transition = 'transform 0.3s ease-in, opacity 0.3s ease-in';
            rewardDisplayContainerElem.style.transform = 'translateY(-50px) translateX(-10px)';
            rewardDisplayContainerElem.style.opacity = '0';
        }, 1000);

        setTimeout(() => {
            rewardDisplayContainerElem.style.display = 'none';
            rewardDisplayContainerElem.style.transform = 'translateY(100%) translateX(100%)';
        }, 1300);
    }

    function hideAllRewards() {
        if (rewardDisplayContainerElem) { rewardDisplayContainerElem.style.display = 'none'; }
    }

    function setupMusicControls() {
        if (!playPauseMusicButtonElem || !backgroundAudioElem) { console.error("Music elements not found."); return; }
        playPauseMusicButtonElem.onclick = function() { if (!isMusicUserInitiated || backgroundAudioElem.paused) { playCurrentTrack(); } else { backgroundAudioElem.pause(); playPauseMusicButtonElem.textContent = 'é–‹å•ŸèƒŒæ™¯éŸ³æ¨‚'; }};
        backgroundAudioElem.onended = function() { currentTrackIndex = (currentTrackIndex + 1) % musicPlaylist.length; loadTrack(currentTrackIndex, true); };
        backgroundAudioElem.onerror = function(e) { playPauseMusicButtonElem.textContent = 'æ’­æ”¾éŒ¯èª¤'; playPauseMusicButtonElem.disabled = true; console.error("Audio error:", e);};
        if (musicPlaylist.length === 0) { playPauseMusicButtonElem.textContent = 'ç„¡éŸ³æ¨‚'; playPauseMusicButtonElem.disabled = true; }
        else { playPauseMusicButtonElem.textContent = 'é–‹å•ŸèƒŒæ™¯éŸ³æ¨‚'; playPauseMusicButtonElem.disabled = false; loadTrack(0, false); }
    }

    function loadTrack(trackIndex, playWhenLoaded = false) {
        if (!backgroundAudioElem || !playPauseMusicButtonElem ) { return; }
        currentTrackIndex = (trackIndex < 0 || trackIndex >= musicPlaylist.length) ? 0 : trackIndex;
        if (musicPlaylist.length === 0) { playPauseMusicButtonElem.textContent = 'ç„¡éŸ³æ¨‚'; playPauseMusicButtonElem.disabled = true; return; }
        const track = musicPlaylist[currentTrackIndex];
        if (!track || !track.path) { playPauseMusicButtonElem.textContent = 'éŸ³è»ŒéŒ¯èª¤'; playPauseMusicButtonElem.disabled = true; return; }
        backgroundAudioElem.src = track.path; backgroundAudioElem.load();
        if (playWhenLoaded) playCurrentTrack(); else { playPauseMusicButtonElem.textContent = 'é–‹å•ŸèƒŒæ™¯éŸ³æ¨‚'; playPauseMusicButtonElem.disabled = false; }
    }

    function playCurrentTrack() {
        if (!backgroundAudioElem || !playPauseMusicButtonElem) { return; }
        if (musicPlaylist.length === 0) { return; }
        const playPromise = backgroundAudioElem.play();
        if (playPromise !== undefined) {
            playPromise.then(() => { playPauseMusicButtonElem.textContent = 'é—œé–‰èƒŒæ™¯éŸ³æ¨‚'; isMusicUserInitiated = true; })
                       .catch(error => { console.warn("Audio play failed:", error); playPauseMusicButtonElem.textContent = 'é–‹å•ŸèƒŒæ™¯éŸ³æ¨‚'; });
        }
    }

    // --- Window Onload: The main entry point ---
    window.onload = function() {
        console.log("window.onload executed.");
        initializeDOMReferences();
        setupEventListeners();
        initializeAppState();
        populateLinksPage(); 
        populateSocialLinks();
    };
  </script>
</body>
</html>